FROM arm64v8/ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Etc/UTC
SHELL ["/bin/bash", "-c"]

# Set locale
RUN apt-get update && apt-get install -y locales \
    && locale-gen en_US en_US.UTF-8 \
    && update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8

ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# Install base tools
RUN apt-get update && apt-get install -y \
    curl wget gnupg2 lsb-release git build-essential \
    python3-pip python3-colcon-common-extensions \
    python3-vcstool python3-rosdep software-properties-common

# Initialize rosdep
RUN rosdep init || true && rosdep update

### ------------------------
### Install ROS1 Noetic
### ------------------------
RUN echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros1-latest.list \
 && curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add - \
 && apt-get update \
 && apt-get install -y ros-noetic-desktop-full python3-rosinstall python3-rosinstall-generator python3-wstool

# Source ROS1
RUN echo "source /opt/ros/noetic/setup.bash" >> /root/.bashrc

# Create ROS1 workspace
RUN mkdir -p /root/catkin_ws/src \
 && /bin/bash -c "source /opt/ros/noetic/setup.bash && cd /root/catkin_ws && catkin_make"

### ------------------------
### Install ROS2 Humble
### ------------------------
RUN add-apt-repository universe \
 && curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add - \
 && echo "deb [arch=arm64] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" > /etc/apt/sources.list.d/ros2-latest.list \
 && apt-get update \
 && apt-get install -y ros-humble-desktop

# Source ROS2
RUN echo "source /opt/ros/humble/setup.bash" >> /root/.bashrc

# Create ROS2 workspace
RUN mkdir -p /root/ros2_ws/src

# Clone ros1_bridge
WORKDIR /root/ros2_ws
RUN git clone https://github.com/ros2/ros1_bridge.git src/ros1_bridge \
 && vcs import src < src/ros1_bridge/ros1_bridge.repos

# Build ros1_bridge
RUN /bin/bash -c "source /opt/ros/noetic/setup.bash && source /opt/ros/humble/setup.bash && cd /root/ros2_ws && colcon build --packages-select ros1_bridge --cmake-force-configure"

# Source ROS1, ROS2, and bridge in .bashrc
RUN echo 'source /opt/ros/noetic/setup.bash' >> /root/.bashrc \
 && echo 'source /opt/ros/humble/setup.bash' >> /root/.bashrc \
 && echo 'source /root/catkin_ws/devel/setup.bash' >> /root/.bashrc \
 && echo 'source /root/ros2_ws/install/setup.bash' >> /root/.bashrc \
 && echo 'cd /root/ros2_ws' >> /root/.bashrc

# Default command: open bash in ROS2 workspace
WORKDIR /root/ros2_ws
CMD ["/bin/bash"]
